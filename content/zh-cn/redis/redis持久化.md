---
title: "redis持久化"
date: 2020-05-02T20:20:42+08:00
draft: false
type: posts
categories: ["Redis"]
tags: ['redis']
---

### redis持久化

两种方式：RDB、AOF

RDB，redis-database，使用压缩的二进制文件保存的是redis内存中完整的数据，相当于数据的快照，默认的持久化方式，可以手动执行以下命令执行，可以在配置文件中自动执行

* SAVE命令：会阻塞服务器进程，此时所有命令都会一直阻塞直到save命令执行完毕
* BGSAVE命令：会重新起一个进程处理，不会阻塞任何命令

恢复过程：

* 如果没开启AOF持久化，服务器才会使用RDB文件还原数据
* 如果开启了AOF持久化，服务器会优先使用AOF文件还原数据

AOF，append-only-file，默认关闭，服务器在执行完写命令后，会以协议格式将命令追加到AOF缓冲区，然后服务器根据appendfsync选项决定何时将AOF缓冲区内容写入到AOF文件。

appendfsync：

* always，每个写命令都会同步到AOF文件，是最安全的方式，即使故障停机，丢失数据最多就一个写命令的数据
* everysec，每秒钟都会同步数据到AOF文件，故障停机最多就丢失一秒钟的写入命令的数据，是AOF方式的默认值
* no，从不同步数据，出现故障后，会丢失上次同步之后的所有写入数据

恢复过程：

* 创建一个伪客户端
* 从AOF文件分析并读取一条写命令
* 伪客户端执行命令
* 重复上两个步骤，直到AOF文件所有写命令执行完毕

随着运行时间的增加，AOF文件会越来越大，占用的磁盘空间会增加，而且数据恢复的过程所耗费的时间也会增加，为了解决这一问题，redis提供了AOF重写功能：redis会创建一个新的AOF文件替代现有AOF文件，新旧两个文件保存的数据相同，只不过新AOF文件保存的是精简后的命令，不会浪费存储空间

AOF重写过程：

* 服务器创建子进程，子进程开始AOF文件重写
* 服务器执行所有命令外还要将写命令写入AOF缓冲区和AOF重写缓冲区
* 子进程完成AOF重写后向父进程发送信号，父进程收到信号后：
  * 将AOF重写缓冲区内容写入到新AOF文件中，保证新AOF文件保存的数据和服务器当前的数据一致
  * 对新AOF文件重命名，覆盖现有AOF文件，完成新旧AOF文件替换

###### 两种持久化方式的区别

* 实现方式

  RDB持久化记录的是结果，AOF持久化记录的是过程

* 文件体积

  记录结果的方式肯定比记录过程的方式占用的存储空间小，即：RDB文件占用的存储空间小

* 安全性

  AOF的安全性要比RDB的高。RDB持久化会丢失从上次保存以后的数据，而AOF持久化最多丢失1s的数据

* 优先级

  AOF的优先级比RDB的高

